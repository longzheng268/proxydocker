// _worker.js
// Modular Docker Hub Reverse Proxy for Cloudflare Workers
// Core functionality is isolated to ensure basic operations always work

// ============================================================================
// CORE CONFIGURATION - Critical for basic proxy functionality
// ============================================================================

// Dockeré•œåƒä»“åº“ä¸»æœºåœ°å€
let hub_host = 'registry-1.docker.io';
// Dockerè®¤è¯æœåŠ¡å™¨åœ°å€
const auth_url = 'https://auth.docker.io';
// è‡ªå®šä¹‰çš„å·¥ä½œæœåŠ¡å™¨åœ°å€
let workers_url = 'https://proxydocker.lz-0315.com';

let å±è”½çˆ¬è™«UA = ['netcraft'];

// ============================================================================
// CORE ROUTING - Essential for proxy functionality
// ============================================================================

/**
 * æ ¹æ®ä¸»æœºåé€‰æ‹©å¯¹åº”çš„ä¸Šæ¸¸åœ°å€
 * @param {string} host ä¸»æœºå
 * @returns {Array} [upstream_host, needs_fake_page]
 */
function routeByHosts(host) {
	// å®šä¹‰è·¯ç”±è¡¨
	const routes = {
		// ç”Ÿäº§ç¯å¢ƒ
		"quay": "quay.io",
		"gcr": "gcr.io",
		"k8s-gcr": "k8s.gcr.io",
		"k8s": "registry.k8s.io",
		"ghcr": "ghcr.io",
		"cloudsmith": "docker.cloudsmith.io",
		"nvcr": "nvcr.io",
		
		// æµ‹è¯•ç¯å¢ƒ
		"test": "registry-1.docker.io",
	};

	if (host in routes) return [ routes[host], false ];
	else return [ hub_host, true ];
}

// ============================================================================
// CORE UTILITIES - Essential helper functions
// ============================================================================

/** @type {RequestInit} */
const PREFLIGHT_INIT = {
	// é¢„æ£€è¯·æ±‚é…ç½®
	headers: new Headers({
		'access-control-allow-origin': '*', // å…è®¸æ‰€æœ‰æ¥æº
		'access-control-allow-methods': 'GET,POST,PUT,PATCH,TRACE,DELETE,HEAD,OPTIONS', // å…è®¸çš„HTTPæ–¹æ³•
		'access-control-max-age': '1728000', // é¢„æ£€è¯·æ±‚çš„ç¼“å­˜æ—¶é—´
	}),
}

/**
 * æ„é€ å“åº”
 * @param {any} body å“åº”ä½“
 * @param {number} status å“åº”çŠ¶æ€ç 
 * @param {Object<string, string>} headers å“åº”å¤´
 */
function makeRes(body, status = 200, headers = {}) {
	headers['access-control-allow-origin'] = '*' // å…è®¸æ‰€æœ‰æ¥æº
	return new Response(body, { status, headers }) // è¿”å›æ–°æ„é€ çš„å“åº”
}

/**
 * æ„é€ æ–°çš„URLå¯¹è±¡
 * @param {string} urlStr URLå­—ç¬¦ä¸²
 */
function newUrl(urlStr) {
	try {
		return new URL(urlStr) // å°è¯•æ„é€ æ–°çš„URLå¯¹è±¡
	} catch (err) {
		return null // æ„é€ å¤±è´¥è¿”å›null
	}
}

/**
 * æ£€æŸ¥æ˜¯å¦ä¸ºUUIDæ ¼å¼
 * @param {string} uuid UUIDå­—ç¬¦ä¸²
 * @returns {boolean}
 */
function isUUID(uuid) {
	// å®šä¹‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¥åŒ¹é… UUID æ ¼å¼
	const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
	
	// ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯• UUID å­—ç¬¦ä¸²
	return uuidRegex.test(uuid);
}

/**
 * è§£æç¯å¢ƒå˜é‡é…ç½®
 * @param {string} envadd ç¯å¢ƒå˜é‡å†…å®¹
 * @returns {Array<string>}
 */
async function ADD(envadd) {
	var addtext = envadd.replace(/[	 |"'\r\n]+/g, ',').replace(/,+/g, ',');	// å°†ç©ºæ ¼ã€åŒå¼•å·ã€å•å¼•å·å’Œæ¢è¡Œç¬¦æ›¿æ¢ä¸ºé€—å·
	if (addtext.charAt(0) == ',') addtext = addtext.slice(1);
	if (addtext.charAt(addtext.length - 1) == ',') addtext = addtext.slice(0, addtext.length - 1);
	const add = addtext.split(',');
	return add;
}

// ============================================================================
// UI MODULE - Web interface (isolated, won't affect proxy functionality)
// ============================================================================

// ============================================================================
// UI MODULE - Web interface (isolated, won't affect proxy functionality)
// ============================================================================

/**
 * Nginxä¼ªè£…é¡µé¢ - ç”¨äºçˆ¬è™«è®¿é—®æ—¶çš„ä¼ªè£…
 * @returns {Promise<string>}
 */
async function nginx() {
	const text = `
	<!DOCTYPE html>
	<html>
	<head>
	<title>Welcome to nginx!</title>
	<style>
		body {
			width: 35em;
			margin: 0 auto;
			font-family: Tahoma, Verdana, Arial, sans-serif;
		}
	</style>
	</head>
	<body>
	<h1>Welcome to nginx!</h1>
	<p>If you see this page, the nginx web server is successfully installed and
	working. Further configuration is required.</p>
	
	<p>For online documentation and support please refer to
	<a href="http://nginx.org/">nginx.org</a>.<br/>
	Commercial support is available at
	<a href="http://nginx.com/">nginx.com</a>.</p>
	
	<p><em>Thank you for using nginx.</em></p>
	</body>
	</html>
	`
	return text;
}

/**
 * æœç´¢ç•Œé¢ - å¸¦åŠ¨ç”»æ•ˆæœå’Œå“åº”å¼è®¾è®¡
 * @returns {Promise<string>}
 */
/**
 * å¢å¼ºçš„æœç´¢ç•Œé¢ - åŒ…å«ä½¿ç”¨è¯´æ˜å’Œé•œåƒè½¬æ¢å™¨
 * @param {string} hostname å½“å‰ä¸»æœºå
 * @returns {Promise<string>}
 */
async function searchInterface(hostname) {
	const proxyDomain = hostname || 'your-proxy.workers.dev';
	
	const text = `
	<!DOCTYPE html>
	<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Docker Hub ä»£ç†æœåŠ¡ - ä½¿ç”¨è¯´æ˜</title>
		<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px;
		}
		
		.container {
			max-width: 1200px;
			margin: 0 auto;
			position: relative;
			z-index: 2;
		}
		
		/* å¤´éƒ¨ */
		.header {
			text-align: center;
			padding: 40px 20px;
			animation: fadeInDown 0.8s ease-out;
		}
		
		@keyframes fadeInDown {
			from {
				opacity: 0;
				transform: translateY(-30px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		.logo {
			margin-bottom: 20px;
			animation: float 3s ease-in-out infinite;
		}
		
		@keyframes float {
			0%, 100% { transform: translateY(0px); }
			50% { transform: translateY(-10px); }
		}
		
		.logo svg {
			filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
		}
		
		h1 {
			color: white;
			font-size: 2.5em;
			margin-bottom: 10px;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
		}
		
		.subtitle {
			color: rgba(255, 255, 255, 0.95);
			font-size: 1.2em;
			margin-bottom: 30px;
		}
		
		/* å†…å®¹å¡ç‰‡ */
		.card {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 15px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
			animation: fadeInUp 0.6s ease-out;
			animation-fill-mode: both;
		}
		
		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		.card:nth-child(2) { animation-delay: 0.1s; }
		.card:nth-child(3) { animation-delay: 0.2s; }
		.card:nth-child(4) { animation-delay: 0.3s; }
		.card:nth-child(5) { animation-delay: 0.4s; }
		
		.card h2 {
			color: #333;
			font-size: 1.8em;
			margin-bottom: 20px;
			border-bottom: 3px solid #667eea;
			padding-bottom: 10px;
		}
		
		.card h3 {
			color: #555;
			font-size: 1.3em;
			margin: 20px 0 10px 0;
		}
		
		.card p {
			color: #666;
			line-height: 1.8;
			margin-bottom: 15px;
		}
		
		/* æœç´¢åŒºåŸŸ */
		.search-section {
			display: flex;
			align-items: center;
			gap: 15px;
			margin: 20px 0;
		}
		
		.search-input {
			flex: 1;
			padding: 16px 24px;
			font-size: 16px;
			border: 2px solid #ddd;
			border-radius: 50px;
			background: white;
			transition: all 0.3s ease;
			outline: none;
		}
		
		.search-input:focus {
			border-color: #667eea;
			box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
		}
		
		.search-button {
			padding: 16px 32px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			border-radius: 50px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		
		.search-button:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
		}
		
		/* è½¬æ¢å™¨åŒºåŸŸ */
		.converter {
			background: #f8f9fa;
			padding: 20px;
			border-radius: 10px;
			margin: 20px 0;
		}
		
		.converter-input {
			width: 100%;
			padding: 14px 20px;
			font-size: 15px;
			border: 2px solid #ddd;
			border-radius: 8px;
			margin-bottom: 15px;
			font-family: 'Courier New', monospace;
		}
		
		.converter-output {
			background: #fff;
			border: 2px solid #667eea;
			border-radius: 8px;
			padding: 14px 20px;
			font-family: 'Courier New', monospace;
			font-size: 14px;
			color: #333;
			min-height: 50px;
			word-break: break-all;
			display: none;
		}
		
		.converter-output.show {
			display: block;
		}
		
		.copy-button {
			background: #667eea;
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 6px;
			cursor: pointer;
			margin-top: 10px;
			font-size: 14px;
			transition: all 0.3s ease;
		}
		
		.copy-button:hover {
			background: #5568d3;
		}
		
		.copy-button:active {
			transform: scale(0.95);
		}
		
		/* ä»£ç å— */
		.code-block {
			background: #2d2d2d;
			color: #f8f8f2;
			padding: 20px;
			border-radius: 8px;
			margin: 15px 0;
			overflow-x: auto;
			font-family: 'Courier New', monospace;
			font-size: 14px;
			line-height: 1.6;
			position: relative;
		}
		
		.code-block code {
			display: block;
		}
		
		.code-block .copy-code {
			position: absolute;
			top: 10px;
			right: 10px;
			background: rgba(255, 255, 255, 0.1);
			color: white;
			border: 1px solid rgba(255, 255, 255, 0.2);
			padding: 6px 12px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 12px;
			transition: all 0.3s ease;
		}
		
		.code-block .copy-code:hover {
			background: rgba(255, 255, 255, 0.2);
		}
		
		.command {
			color: #50fa7b;
		}
		
		.comment {
			color: #6272a4;
		}
		
		/* æç¤ºæ¡† */
		.tip {
			background: #e7f3ff;
			border-left: 4px solid #2196F3;
			padding: 15px;
			margin: 15px 0;
			border-radius: 4px;
		}
		
		.tip strong {
			color: #1976D2;
		}
		
		.warning {
			background: #fff3e0;
			border-left: 4px solid #ff9800;
			padding: 15px;
			margin: 15px 0;
			border-radius: 4px;
		}
		
		.warning strong {
			color: #f57c00;
		}
		
		/* åŠŸèƒ½åˆ—è¡¨ */
		.features {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 15px;
			margin: 20px 0;
		}
		
		.feature-item {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 20px;
			border-radius: 10px;
			transition: all 0.3s ease;
		}
		
		.feature-item:hover {
			transform: translateY(-5px);
			box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
		}
		
		.feature-item h4 {
			font-size: 1.1em;
			margin-bottom: 8px;
		}
		
		.feature-item p {
			color: rgba(255, 255, 255, 0.9);
			font-size: 0.9em;
			margin: 0;
		}
		
		/* å“åº”å¼ */
		@media (max-width: 768px) {
			h1 { font-size: 2em; }
			.card { padding: 20px; }
			.search-section {
				flex-direction: column;
			}
			.search-input {
				width: 100%;
			}
		}
		
		@media (max-width: 480px) {
			h1 { font-size: 1.6em; }
			.subtitle { font-size: 1em; }
			.card h2 { font-size: 1.4em; }
		}
		</style>
	</head>
	<body>
		<div class="container">
			<!-- å¤´éƒ¨ -->
			<div class="header">
				<div class="logo">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 18" fill="#ffffff" width="120" height="90">
						<path d="M23.763 6.886c-.065-.053-.673-.512-1.954-.512-.32 0-.659.03-1.01.087-.248-1.703-1.651-2.533-1.716-2.57l-.345-.2-.227.328a4.596 4.596 0 0 0-.611 1.433c-.23.972-.09 1.884.403 2.666-.596.331-1.546.418-1.744.42H.752a.753.753 0 0 0-.75.749c-.007 1.456.233 2.864.692 4.07.545 1.43 1.355 2.483 2.409 3.13 1.181.725 3.104 1.14 5.276 1.14 1.016 0 2.03-.092 2.93-.266 1.417-.273 2.705-.742 3.826-1.391a10.497 10.497 0 0 0 2.61-2.14c1.252-1.42 1.998-3.005 2.553-4.408.075.003.148.005.221.005 1.371 0 2.215-.55 2.68-1.01.505-.5.685-.998.704-1.053L24 7.076l-.237-.19Z"></path>
						<path d="M2.216 8.075h2.119a.186.186 0 0 0 .185-.186V6a.186.186 0 0 0-.185-.186H2.216A.186.186 0 0 0 2.031 6v1.89c0 .103.083.186.185.186Zm2.92 0h2.118a.185.185 0 0 0 .185-.186V6a.185.185 0 0 0-.185-.186H5.136A.185.185 0 0 0 4.95 6v1.89c0 .103.083.186.186.186Zm2.964 0h2.118a.186.186 0 0 0 .185-.186V6a.186.186 0 0 0-.185-.186H8.1A.185.185 0 0 0 7.914 6v1.89c0 .103.083.186.186.186Zm2.928 0h2.119a.185.185 0 0 0 .185-.186V6a.185.185 0 0 0-.185-.186h-2.119a.186.186 0 0 0-.185.186v1.89c0 .103.083.186.185.186Zm-5.892-2.72h2.118a.185.185 0 0 0 .185-.186V3.28a.186.186 0 0 0-.185-.186H5.136a.186.186 0 0 0-.186.186v1.89c0 .103.083.186.186.186Zm2.964 0h2.118a.186.186 0 0 0 .185-.186V3.28a.186.186 0 0 0-.185-.186H8.1a.186.186 0 0 0-.186.186v1.89c0 .103.083.186.186.186Zm2.928 0h2.119a.185.185 0 0 0 .185-.186V3.28a.186.186 0 0 0-.185-.186h-2.119a.186.186 0 0 0-.185.186v1.89c0 .103.083.186.185.186Zm0-2.72h2.119a.186.186 0 0 0 .185-.186V.56a.185.185 0 0 0-.185-.186h-2.119a.186.186 0 0 0-.185.186v1.89c0 .103.083.186.185.186Zm2.955 5.44h2.118a.185.185 0 0 0 .186-.186V6a.185.185 0 0 0-.186-.186h-2.118a.185.185 0 0 0-.185.186v1.89c0 .103.083.186.185.186Z"></path>
					</svg>
				</div>
				<h1>Docker Hub ä»£ç†æœåŠ¡</h1>
				<p class="subtitle">ğŸš€ å¿«é€Ÿã€å®‰å…¨ã€å…è´¹çš„ Docker é•œåƒä»£ç†</p>
			</div>
			
			<!-- æœç´¢é•œåƒ -->
			<div class="card">
				<h2>ğŸ” æœç´¢ Docker é•œåƒ</h2>
				<p>è¾“å…¥å…³é”®è¯æœç´¢ Docker Hub ä¸Šçš„é•œåƒï¼š</p>
				<div class="search-section">
					<input type="text" id="search-input" class="search-input" placeholder="ä¾‹å¦‚ï¼šnginx, redis, mysql..." autocomplete="off">
					<button id="search-button" class="search-button">æœç´¢</button>
				</div>
			</div>
			
			<!-- é•œåƒè½¬æ¢å™¨ -->
			<div class="card">
				<h2>ğŸ”„ é•œåƒåœ°å€è½¬æ¢å™¨</h2>
				<p>å·²çŸ¥å®˜æ–¹é•œåƒåç§°æˆ–é“¾æ¥ï¼Ÿå¿«é€Ÿç”Ÿæˆä»£ç†åœ°å€å’Œæ‹‰å–å‘½ä»¤ï¼š</p>
				
				<div class="converter">
					<input type="text" id="convert-input" class="converter-input" placeholder="è¾“å…¥å®˜æ–¹é•œåƒåç§°æˆ–é“¾æ¥ï¼Œä¾‹å¦‚ï¼šnginx:latest æˆ– library/nginx:latest">
					<div id="convert-output" class="converter-output"></div>
				</div>
			</div>
			
			<!-- å¿«é€Ÿå¼€å§‹ -->
			<div class="card">
				<h2>âš¡ å¿«é€Ÿå¼€å§‹</h2>
				
				<h3>æ–¹æ³•ä¸€ï¼šé…ç½® Docker é•œåƒåŠ é€Ÿå™¨ï¼ˆæ¨èï¼‰</h3>
				<p>ä¸€æ¬¡é…ç½®ï¼Œå…¨å±€ç”Ÿæ•ˆï¼Œæ— éœ€ä¿®æ”¹æ‹‰å–å‘½ä»¤ã€‚</p>
				
				<div class="code-block">
					<button class="copy-code" onclick="copyCode(this)">å¤åˆ¶</button>
					<code><span class="comment"># 1. ç¼–è¾‘ Docker é…ç½®æ–‡ä»¶</span>
sudo nano /etc/docker/daemon.json

<span class="comment"># 2. æ·»åŠ ä»¥ä¸‹å†…å®¹</span>
{
  "registry-mirrors": ["https://${proxyDomain}"]
}

<span class="comment"># 3. é‡å¯ Docker æœåŠ¡</span>
sudo systemctl daemon-reload
sudo systemctl restart docker

<span class="comment"># 4. éªŒè¯é…ç½®</span>
docker info | grep "Registry Mirrors"</code>
				</div>
				
				<div class="tip">
					<strong>ğŸ’¡ æç¤ºï¼š</strong> é…ç½®åï¼Œæ‰€æœ‰ <code>docker pull</code> å‘½ä»¤éƒ½ä¼šè‡ªåŠ¨ä½¿ç”¨ä»£ç†ï¼Œæ— éœ€ä¿®æ”¹å‘½ä»¤ã€‚
				</div>
				
				<h3>æ–¹æ³•äºŒï¼šç›´æ¥ä½¿ç”¨ä»£ç†åœ°å€</h3>
				<p>æ— éœ€é…ç½®ï¼Œç›´æ¥åœ¨æ‹‰å–å‘½ä»¤ä¸­æŒ‡å®šä»£ç†åœ°å€ã€‚</p>
				
				<div class="code-block">
					<button class="copy-code" onclick="copyCode(this)">å¤åˆ¶</button>
					<code><span class="comment"># å®˜æ–¹é•œåƒ</span>
<span class="command">docker pull ${proxyDomain}/library/nginx:latest</span>

<span class="comment"># ç”¨æˆ·é•œåƒ</span>
<span class="command">docker pull ${proxyDomain}/username/imagename:tag</span></code>
				</div>
			</div>
			
			<!-- ä½¿ç”¨ç¤ºä¾‹ -->
			<div class="card">
				<h2>ğŸ“ ä½¿ç”¨ç¤ºä¾‹</h2>
				
				<h3>æ‹‰å–å®˜æ–¹é•œåƒ</h3>
				<div class="code-block">
					<button class="copy-code" onclick="copyCode(this)">å¤åˆ¶</button>
					<code><span class="comment"># Nginx</span>
<span class="command">docker pull ${proxyDomain}/library/nginx:alpine</span>

<span class="comment"># Redis</span>
<span class="command">docker pull ${proxyDomain}/library/redis:latest</span>

<span class="comment"># MySQL</span>
<span class="command">docker pull ${proxyDomain}/library/mysql:8.0</span></code>
				</div>
				
				<h3>æ‹‰å–ç”¨æˆ·é•œåƒ</h3>
				<div class="code-block">
					<button class="copy-code" onclick="copyCode(this)">å¤åˆ¶</button>
					<code><span class="command">docker pull ${proxyDomain}/bitnami/postgresql:latest</span>
<span class="command">docker pull ${proxyDomain}/grafana/grafana:latest</span></code>
				</div>
			</div>
			
			<!-- ä¸»è¦åŠŸèƒ½ -->
			<div class="card">
				<h2>âœ¨ ä¸»è¦åŠŸèƒ½</h2>
				<div class="features">
					<div class="feature-item">
						<h4>ğŸš€ å…¨çƒåŠ é€Ÿ</h4>
						<p>Cloudflare CDN åŠ é€Ÿï¼Œå…¨çƒè®¿é—®é£å¿«</p>
					</div>
					<div class="feature-item">
						<h4>ğŸ”’ å®‰å…¨å¯é </h4>
						<p>HTTPS åŠ å¯†ä¼ è¾“ï¼Œä¿æŠ¤æ‚¨çš„æ•°æ®å®‰å…¨</p>
					</div>
					<div class="feature-item">
						<h4>ğŸ’° å®Œå…¨å…è´¹</h4>
						<p>åŸºäº Cloudflare Workersï¼Œå…è´¹ä½¿ç”¨</p>
					</div>
					<div class="feature-item">
						<h4>ğŸŒ å¤šä»“åº“æ”¯æŒ</h4>
						<p>æ”¯æŒ Docker Hub, GCR, Quay ç­‰</p>
					</div>
				</div>
			</div>
			
			<!-- å¸¸è§é—®é¢˜ -->
			<div class="card">
				<h2>â“ å¸¸è§é—®é¢˜</h2>
				
				<h3>å¦‚ä½•æ‹‰å–ç§æœ‰é•œåƒï¼Ÿ</h3>
				<p>é¦–å…ˆç™»å½•åˆ°ä»£ç†æœåŠ¡å™¨ï¼š</p>
				<div class="code-block">
					<button class="copy-code" onclick="copyCode(this)">å¤åˆ¶</button>
					<code><span class="command">docker login ${proxyDomain}</span>
<span class="comment"># è¾“å…¥æ‚¨çš„ Docker Hub ç”¨æˆ·åå’Œå¯†ç </span></code>
				</div>
				
				<h3>æ”¯æŒå“ªäº›é•œåƒä»“åº“ï¼Ÿ</h3>
				<p>ç›®å‰æ”¯æŒä»¥ä¸‹é•œåƒä»“åº“ï¼š</p>
				<ul style="margin-left: 20px; line-height: 2;">
					<li>Docker Hub (é»˜è®¤)</li>
					<li>Google Container Registry (gcr.io)</li>
					<li>Quay.io</li>
					<li>GitHub Container Registry (ghcr.io)</li>
					<li>Kubernetes Registry (registry.k8s.io)</li>
				</ul>
			</div>
		</div>
		
		<script>
		// æœç´¢åŠŸèƒ½
		function performSearch() {
			const query = document.getElementById('search-input').value.trim();
			if (query) {
				window.location.href = '/search?q=' + encodeURIComponent(query) + '&page=1';
			}
		}
		
		document.getElementById('search-button').addEventListener('click', performSearch);
		document.getElementById('search-input').addEventListener('keypress', function(event) {
			if (event.key === 'Enter') {
				performSearch();
			}
		});
		
		// é•œåƒè½¬æ¢å™¨
		document.getElementById('convert-input').addEventListener('input', function() {
			const input = this.value.trim();
			const output = document.getElementById('convert-output');
			
			if (!input) {
				output.classList.remove('show');
				return;
			}
			
			let imageName = input;
			
			// å¤„ç†Docker Hubé“¾æ¥
			if (input.includes('hub.docker.com')) {
				const match = input.match(/hub\\.docker\\.com\\/(?:_\\/)?([^/]+)\\/([^/\\s]+)/);
				if (match) {
					imageName = match[1] + '/' + match[2].replace(/\\/.*$/, '');
				}
			}
			
			// å¤„ç†é•œåƒåç§°
			let proxyImage = imageName;
			
			// å¦‚æœæ²¡æœ‰æ–œæ ï¼Œè¯´æ˜æ˜¯å®˜æ–¹é•œåƒï¼ŒåŠ ä¸Š library å‰ç¼€
			if (!imageName.includes('/')) {
				proxyImage = 'library/' + imageName;
			}
			
			// ç”Ÿæˆä»£ç†åœ°å€å’Œå‘½ä»¤
			const proxyDomain = '${proxyDomain}';
			const pullCommand = \`docker pull \${proxyDomain}/\${proxyImage}\`;
			
			output.innerHTML = \`
				<div style="margin-bottom: 10px;">
					<strong>ä»£ç†åœ°å€ï¼š</strong><br>
					<code>\${proxyDomain}/\${proxyImage}</code>
				</div>
				<div>
					<strong>æ‹‰å–å‘½ä»¤ï¼š</strong><br>
					<code>\${pullCommand}</code>
				</div>
				<button class="copy-button" onclick="copyToClipboard('\${pullCommand}')">å¤åˆ¶å‘½ä»¤</button>
			\`;
			
			output.classList.add('show');
		});
		
		// å¤åˆ¶ä»£ç å—
		function copyCode(button) {
			const codeBlock = button.parentElement.querySelector('code');
			const text = codeBlock.textContent;
			copyToClipboard(text);
			
			const originalText = button.textContent;
			button.textContent = 'å·²å¤åˆ¶ï¼';
			setTimeout(() => {
				button.textContent = originalText;
			}, 2000);
		}
		
		// å¤åˆ¶åˆ°å‰ªè´´æ¿
		function copyToClipboard(text) {
			if (navigator.clipboard && navigator.clipboard.writeText) {
				navigator.clipboard.writeText(text).then(() => {
					console.log('Copied to clipboard');
				}).catch(err => {
					console.error('Failed to copy: ', err);
					fallbackCopyTextToClipboard(text);
				});
			} else {
				fallbackCopyTextToClipboard(text);
			}
		}
		
		function fallbackCopyTextToClipboard(text) {
			const textArea = document.createElement("textarea");
			textArea.value = text;
			textArea.style.position = "fixed";
			textArea.style.top = "-9999px";
			document.body.appendChild(textArea);
			textArea.focus();
			textArea.select();
			
			try {
				document.execCommand('copy');
				console.log('Fallback: Copied to clipboard');
			} catch (err) {
				console.error('Fallback: Failed to copy', err);
			}
			
			document.body.removeChild(textArea);
		}
		</script>
	</body>
	</html>
	`;
	return text;
}
